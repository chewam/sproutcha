<!DOCTYPE html>
<html>
  <head>
    <title>sproutcha :: model :: sproutcore</title>
    <link rel="stylesheet" href="http://twitter.github.com/bootstrap/1.3.0/bootstrap.min.css">

    <script src="http://code.jquery.com/jquery-1.7rc2.min.js" type="text/javascript"></script>
    <script src="assets/sproutcore.js" type="text/javascript"></script>
    <script src="assets/sproutcore-datastore.js" type="text/javascript"></script>

    <style>
      form {
        margin-top: 20px;
        padding-top: 20px;
        border-radius: 5px;
        border: 1px solid #DDD;
        width: 480px !important;
      }

      fieldset {
        margin-bottom: 0;
      }

      .actions {
        text-align: right;
        margin-bottom: 0px;
        background-color: transparent;
      }

      .spinner {
        width: 16px;
        height: 16px;
        background: url('assets/ajax-loader.gif') no-repeat;
        float: left;
      }
    </style>
  </head>

  <body>
    <script type="text/x-handlebars">
      {{#view App.Form contentBinding="App.currentEmployee"}}
        <div class="clearfix">
          <label>First name:</label>
          <div class="input">
            {{view App.TextField valueBinding="content.first_name"}}
          </div>
        </div>
        <div class="clearfix">
          <label>Last name:</label>
          <div class="input">
            {{view App.TextField valueBinding="content.last_name"}}
          </div>
        </div>
        <div class="clearfix">
          <label>Salary:</label>
          <div class="input">
            {{view App.TextField valueBinding="content.salary" type="number"}}
          </div>
        </div>
        <div class="actions">
          {{view App.Spinner}}
          {{view App.SaveButton}}
        </div>
      {{/view}}
    </script>

    <script>
      
      App = SC.Application.create({
        store: SC.Store.create().from('App.DataSource')
      });

      App.DataSource = SC.DataSource.extend({

        retrieveRecord: function(store, storeKey, id) {
          var url = 'http://demo.revolunet.com:9876/api/v1/employee/%@'.fmt(id);

          $.getJSON(url, function(data) {
            store.dataSourceDidComplete(storeKey, data[0]);
          });
          return true;
        },

        updateRecord: function(store, storeKey) {
          var id = store.idFor(storeKey),
              url = 'http://demo.revolunet.com:9876/api/v1/employee/%@'.fmt(id),
              record = store.materializeRecord(storeKey);

          $.ajax(url, {
            contentType: 'application/json',
            type: 'PUT',
            data: record.toJSON(true),
            success: function() {
              store.dataSourceDidComplete(storeKey);
            }
          });
        }
      });

      App.Employee = SC.Record.extend({

        primaryKey: 'id',

        first_name: SC.Record.attr(String),
        last_name: SC.Record.attr(String),
        salary: SC.Record.attr(Number),

        toJSON: function(stringify) {
          var data = this.getProperties('first_name', 'last_name', 'salary');
          return stringify ? JSON.stringify(data) : data;
        }
      });

      App.set('currentEmployee', App.store.find(App.Employee, 1));

      App.Form = SC.View.extend({
        tagName: 'form',
        classNames: ['container'],
        submit: function(evt) {
          evt.preventDefault();
          App.store.commitRecords();
        }
      });

      App.TextField = SC.TextField.extend({
        disabledBinding: SC.Binding.not('App.currentEmployee.isLoaded')
      });

      App.SaveButton = SC.Button.extend({
        classNames: ['btn'],
        tagName: 'input',
        type: 'submit',
        attributeBindings: ['value'],
        value: 'Save',
        disabledBinding: SC.Binding.not('App.currentEmployee.isLoaded')
      });

      App.Spinner = SC.View.extend({
        classNames: ['spinner'],
        isVisibleBinding: SC.Binding.not('App.currentEmployee.isLoaded')
      });

    </script>
  </body>
</html>
